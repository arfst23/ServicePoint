//******************************************************************************
 
#include "display.h"

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>

#define DELAY 25
 
//******************************************************************************
// >>> border

#define BORDER_OFFSET 49
#define BORDER_WIDTH 356

static int border_ranges[BORDER_WIDTH][4] =
{
  { 112, 140, 0, 0 },
  { 104, 147, 0, 0 },
  { 99, 152, 0, 0 },
  { 94, 157, 0, 0 },
  { 90, 160, 0, 0 },
  { 87, 163, 0, 0 },
  { 83, 167, 0, 0 },
  { 80, 169, 0, 0 },
  { 79, 170, 0, 0 },
  { 76, 173, 0, 0 },
  { 73, 175, 0, 0 },
  { 71, 177, 0, 0 },
  { 69, 179, 0, 0 },
  { 66, 181, 0, 0 },
  { 64, 183, 0, 0 },
  { 63, 117, 135, 185 },
  { 61, 110, 140, 186 },
  { 59, 104, 146, 187 },
  { 58, 99, 150, 189 },
  { 56, 94, 154, 190 },
  { 54, 91, 158, 192 },
  { 53, 88, 161, 193 },
  { 51, 84, 163, 195 },
  { 49, 82, 166, 196 },
  { 48, 79, 168, 197 },
  { 47, 78, 169, 198 },
  { 46, 75, 171, 199 },
  { 44, 73, 173, 201 },
  { 43, 71, 175, 202 },
  { 41, 69, 177, 203 },
  { 40, 67, 178, 204 },
  { 39, 65, 180, 205 },
  { 38, 63, 181, 206 },
  { 37, 62, 182, 206 },
  { 36, 61, 184, 207 },
  { 34, 59, 185, 209 },
  { 33, 57, 186, 210 },
  { 32, 56, 187, 210 },
  { 31, 54, 189, 211 },
  { 30, 53, 190, 212 },
  { 29, 51, 191, 213 },
  { 28, 50, 192, 214 },
  { 28, 49, 193, 214 },
  { 27, 48, 194, 215 },
  { 26, 47, 195, 216 },
  { 25, 46, 196, 216 },
  { 24, 45, 197, 217 },
  { 23, 44, 198, 218 },
  { 23, 43, 198, 219 },
  { 22, 42, 199, 219 },
  { 21, 41, 200, 220 },
  { 21, 40, 201, 220 },
  { 20, 39, 202, 221 },
  { 19, 38, 202, 221 },
  { 18, 37, 203, 222 },
  { 18, 36, 204, 223 },
  { 17, 35, 204, 223 },
  { 16, 35, 205, 224 },
  { 15, 34, 206, 224 },
  { 15, 33, 206, 224 },
  { 14, 32, 207, 225 },
  { 14, 32, 207, 225 },
  { 13, 31, 208, 226 },
  { 13, 30, 209, 227 },
  { 12, 30, 209, 227 },
  { 12, 29, 210, 227 },
  { 11, 28, 210, 228 },
  { 11, 28, 211, 228 },
  { 11, 27, 211, 228 },
  { 10, 27, 211, 229 },
  { 10, 26, 212, 229 },
  { 10, 26, 212, 229 },
  { 9, 26, 213, 230 },
  { 9, 25, 213, 230 },
  { 9, 24, 213, 230 },
  { 9, 24, 214, 231 },
  { 9, 24, 214, 231 },
  { 8, 23, 214, 231 },
  { 8, 23, 214, 231 },
  { 8, 23, 215, 231 },
  { 8, 23, 215, 232 },
  { 8, 23, 215, 232 },
  { 8, 23, 215, 232 },
  { 8, 23, 216, 232 },
  { 8, 23, 216, 232 },
  { 8, 23, 216, 232 },
  { 8, 22, 216, 232 },
  { 8, 22, 216, 233 },
  { 8, 22, 216, 233 },
  { 8, 22, 216, 233 },
  { 8, 23, 217, 233 },
  { 8, 23, 217, 233 },
  { 8, 23, 217, 233 },
  { 8, 23, 217, 233 },
  { 8, 23, 217, 233 },
  { 8, 23, 217, 233 },
  { 8, 23, 217, 233 },
  { 8, 23, 217, 233 },
  { 8, 23, 217, 233 },
  { 8, 23, 217, 233 },
  { 8, 24, 217, 233 },
  { 9, 24, 217, 233 },
  { 9, 24, 217, 233 },
  { 9, 24, 217, 233 },
  { 9, 24, 216, 233 },
  { 9, 25, 216, 233 },
  { 9, 25, 216, 233 },
  { 10, 26, 216, 233 },
  { 10, 26, 216, 232 },
  { 10, 26, 216, 232 },
  { 10, 26, 216, 232 },
  { 10, 27, 215, 232 },
  { 11, 27, 215, 232 },
  { 11, 27, 215, 232 },
  { 11, 28, 215, 232 },
  { 12, 28, 215, 231 },
  { 12, 29, 214, 231 },
  { 12, 29, 214, 231 },
  { 13, 30, 214, 231 },
  { 13, 30, 214, 231 },
  { 13, 30, 213, 230 },
  { 14, 31, 213, 230 },
  { 14, 31, 213, 230 },
  { 14, 32, 212, 229 },
  { 15, 32, 212, 229 },
  { 15, 33, 211, 229 },
  { 16, 34, 211, 228 },
  { 17, 34, 211, 228 },
  { 17, 35, 210, 228 },
  { 18, 35, 210, 228 },
  { 18, 36, 209, 227 },
  { 19, 37, 209, 227 },
  { 19, 37, 208, 226 },
  { 20, 38, 207, 225 },
  { 20, 39, 207, 225 },
  { 21, 40, 206, 225 },
  { 21, 40, 206, 224 },
  { 22, 41, 205, 224 },
  { 22, 42, 205, 223 },
  { 23, 43, 204, 223 },
  { 24, 44, 203, 222 },
  { 24, 45, 203, 222 },
  { 25, 46, 202, 221 },
  { 26, 47, 201, 221 },
  { 27, 48, 200, 220 },
  { 27, 48, 199, 220 },
  { 28, 49, 198, 219 },
  { 29, 50, 197, 218 },
  { 30, 52, 196, 218 },
  { 31, 53, 195, 217 },
  { 31, 54, 194, 216 },
  { 32, 56, 193, 215 },
  { 33, 57, 192, 214 },
  { 34, 58, 191, 214 },
  { 35, 60, 189, 213 },
  { 36, 62, 188, 212 },
  { 37, 63, 187, 211 },
  { 38, 65, 185, 210 },
  { 39, 67, 183, 210 },
  { 40, 70, 181, 209 },
  { 41, 72, 179, 207 },
  { 43, 75, 177, 206 },
  { 44, 76, 175, 205 },
  { 45, 80, 172, 204 },
  { 46, 83, 169, 203 },
  { 48, 86, 165, 202 },
  { 49, 104, 160, 201 },
  { 51, 104, 154, 199 },
  { 53, 108, 144, 198 },
  { 54, 196, 0, 0 },
  { 55, 195, 0, 0 },
  { 57, 194, 0, 0 },
  { 59, 192, 0, 0 },
  { 62, 190, 0, 0 },
  { 64, 188, 0, 0 },
  { 64, 186, 0, 0 },
  { 61, 183, 0, 0 },
  { 58, 181, 0, 0 },
  { 56, 178, 0, 0 },
  { 55, 176, 0, 0 },
  { 53, 174, 0, 0 },
  { 50, 177, 0, 0 },
  { 48, 179, 0, 0 },
  { 46, 181, 0, 0 },
  { 45, 183, 0, 0 },
  { 43, 102, 115, 185 },
  { 41, 101, 128, 187 },
  { 40, 83, 133, 188 },
  { 39, 78, 140, 189 },
  { 38, 74, 146, 191 },
  { 36, 70, 152, 193 },
  { 35, 67, 156, 194 },
  { 34, 64, 160, 195 },
  { 32, 62, 163, 196 },
  { 31, 59, 166, 198 },
  { 30, 57, 169, 199 },
  { 29, 56, 170, 199 },
  { 28, 54, 172, 201 },
  { 27, 53, 175, 202 },
  { 26, 51, 177, 203 },
  { 25, 49, 178, 204 },
  { 24, 48, 180, 205 },
  { 23, 46, 181, 205 },
  { 23, 45, 183, 206 },
  { 22, 44, 184, 207 },
  { 21, 43, 185, 207 },
  { 20, 42, 186, 209 },
  { 20, 41, 188, 209 },
  { 19, 40, 189, 210 },
  { 18, 39, 190, 211 },
  { 17, 38, 191, 211 },
  { 17, 37, 192, 212 },
  { 16, 36, 193, 213 },
  { 15, 35, 193, 213 },
  { 15, 34, 194, 214 },
  { 14, 34, 195, 214 },
  { 13, 33, 196, 215 },
  { 13, 32, 196, 215 },
  { 12, 31, 197, 216 },
  { 11, 30, 198, 216 },
  { 11, 29, 198, 217 },
  { 10, 29, 199, 218 },
  { 10, 28, 199, 218 },
  { 10, 28, 200, 218 },
  { 9, 27, 201, 219 },
  { 9, 26, 201, 219 },
  { 8, 26, 202, 220 },
  { 8, 25, 202, 220 },
  { 7, 24, 203, 220 },
  { 6, 24, 203, 221 },
  { 6, 23, 204, 221 },
  { 6, 23, 204, 221 },
  { 5, 22, 204, 222 },
  { 5, 22, 205, 222 },
  { 4, 21, 205, 222 },
  { 4, 21, 205, 223 },
  { 4, 20, 206, 223 },
  { 3, 20, 206, 223 },
  { 3, 20, 206, 223 },
  { 3, 19, 207, 223 },
  { 3, 19, 207, 224 },
  { 2, 19, 207, 224 },
  { 2, 18, 207, 224 },
  { 2, 18, 208, 224 },
  { 2, 18, 208, 224 },
  { 1, 17, 208, 225 },
  { 1, 17, 209, 225 },
  { 1, 17, 209, 225 },
  { 1, 17, 209, 225 },
  { 1, 16, 209, 225 },
  { 1, 16, 209, 225 },
  { 0, 16, 209, 225 },
  { 0, 15, 209, 225 },
  { 0, 15, 210, 225 },
  { 0, 15, 210, 226 },
  { 0, 15, 210, 226 },
  { 0, 15, 210, 226 },
  { 0, 15, 210, 226 },
  { 0, 15, 210, 226 },
  { 0, 15, 210, 226 },
  { 0, 14, 210, 226 },
  { 0, 14, 210, 226 },
  { 0, 14, 210, 226 },
  { 0, 14, 210, 226 },
  { 0, 14, 210, 226 },
  { 0, 14, 210, 225 },
  { 0, 14, 210, 225 },
  { 0, 15, 209, 225 },
  { 0, 15, 209, 225 },
  { 0, 15, 209, 225 },
  { 0, 15, 209, 225 },
  { 0, 15, 209, 225 },
  { 0, 16, 209, 225 },
  { 1, 16, 209, 225 },
  { 1, 16, 208, 225 },
  { 1, 17, 208, 224 },
  { 1, 17, 208, 224 },
  { 2, 18, 207, 224 },
  { 2, 18, 207, 224 },
  { 2, 18, 207, 224 },
  { 3, 19, 206, 223 },
  { 3, 19, 206, 223 },
  { 3, 20, 206, 223 },
  { 4, 20, 206, 223 },
  { 4, 21, 205, 222 },
  { 4, 21, 205, 222 },
  { 5, 22, 204, 222 },
  { 5, 22, 204, 221 },
  { 6, 23, 204, 221 },
  { 6, 24, 203, 221 },
  { 7, 24, 203, 221 },
  { 8, 25, 202, 220 },
  { 8, 26, 202, 220 },
  { 9, 27, 201, 219 },
  { 10, 27, 201, 219 },
  { 10, 28, 200, 218 },
  { 11, 29, 199, 218 },
  { 12, 30, 199, 218 },
  { 12, 30, 198, 217 },
  { 13, 31, 198, 216 },
  { 13, 32, 197, 216 },
  { 14, 33, 196, 215 },
  { 15, 34, 196, 215 },
  { 15, 35, 195, 214 },
  { 17, 36, 194, 214 },
  { 17, 37, 193, 213 },
  { 18, 38, 193, 212 },
  { 19, 39, 192, 212 },
  { 19, 40, 191, 211 },
  { 20, 41, 190, 211 },
  { 21, 42, 189, 210 },
  { 22, 44, 188, 209 },
  { 23, 45, 187, 209 },
  { 24, 46, 186, 207 },
  { 25, 47, 185, 207 },
  { 26, 49, 184, 206 },
  { 27, 50, 183, 205 },
  { 28, 51, 182, 205 },
  { 29, 53, 180, 204 },
  { 30, 54, 179, 203 },
  { 31, 56, 178, 202 },
  { 32, 57, 177, 201 },
  { 33, 59, 176, 200 },
  { 34, 61, 174, 199 },
  { 35, 62, 173, 198 },
  { 37, 64, 171, 197 },
  { 38, 66, 170, 196 },
  { 39, 67, 168, 195 },
  { 40, 70, 166, 194 },
  { 42, 72, 164, 193 },
  { 44, 74, 162, 192 },
  { 45, 77, 160, 190 },
  { 46, 80, 158, 189 },
  { 47, 81, 157, 188 },
  { 49, 84, 154, 187 },
  { 50, 88, 151, 185 },
  { 53, 91, 148, 184 },
  { 54, 96, 143, 182 },
  { 56, 101, 139, 180 },
  { 58, 109, 131, 179 },
  { 60, 177, 0, 0 },
  { 61, 176, 0, 0 },
  { 63, 175, 0, 0 },
  { 65, 172, 0, 0 },
  { 67, 170, 0, 0 },
  { 70, 168, 0, 0 },
  { 73, 166, 0, 0 },
  { 75, 163, 0, 0 },
  { 78, 161, 0, 0 },
  { 81, 158, 0, 0 },
  { 83, 157, 0, 0 },
  { 87, 153, 0, 0 },
  { 91, 150, 0, 0 },
  { 96, 145, 0, 0 },
  { 101, 140, 0, 0 },
  { 109, 132, 0, 0 },
};

static void border()
{
  for (int x = 0; x < BORDER_WIDTH; x++)
  {
    for (int y = border_ranges[x][0]; y < border_ranges[x][1]; y++)
      display_set_virt(x + BORDER_OFFSET, y, true);
    for (int y = border_ranges[x][2]; y < border_ranges[x][3]; y++)
      display_set_virt(x + BORDER_OFFSET, y, true);
  }
}

// <<<
//******************************************************************************
// >>> lids

#define LIDS_OFFSET 42
#define LIDS_WIDTH 364

static int lids_ranges[LIDS_WIDTH][4] =
{
  { 125, 130, 117, 120 },
  { 123, 132, 115, 122 },
  { 122, 133, 115, 123 },
  { 122, 134, 114, 124 },
  { 121, 134, 114, 126 },
  { 120, 135, 113, 127 },
  { 120, 135, 113, 128 },
  { 119, 135, 113, 129 },
  { 119, 135, 114, 130 },
  { 118, 135, 114, 132 },
  { 117, 134, 114, 133 },
  { 117, 134, 115, 134 },
  { 116, 133, 115, 135 },
  { 116, 133, 116, 136 },
  { 115, 132, 117, 137 },
  { 115, 132, 118, 138 },
  { 114, 131, 119, 139 },
  { 114, 131, 120, 140 },
  { 114, 130, 121, 141 },
  { 113, 130, 122, 142 },
  { 113, 129, 123, 144 },
  { 113, 129, 124, 146 },
  { 112, 129, 125, 147 },
  { 112, 128, 126, 149 },
  { 112, 127, 127, 150 },
  { 111, 127, 128, 151 },
  { 111, 126, 130, 153 },
  { 110, 126, 131, 154 },
  { 110, 125, 132, 155 },
  { 110, 125, 134, 157 },
  { 109, 125, 135, 158 },
  { 109, 124, 137, 159 },
  { 109, 124, 138, 160 },
  { 108, 124, 140, 161 },
  { 108, 123, 141, 163 },
  { 108, 123, 142, 164 },
  { 107, 123, 143, 165 },
  { 107, 122, 145, 166 },
  { 106, 122, 146, 167 },
  { 106, 121, 147, 168 },
  { 106, 121, 149, 169 },
  { 106, 120, 151, 170 },
  { 105, 120, 152, 172 },
  { 105, 120, 153, 173 },
  { 105, 119, 154, 174 },
  { 104, 119, 155, 175 },
  { 104, 119, 156, 176 },
  { 104, 118, 157, 177 },
  { 103, 118, 158, 178 },
  { 103, 118, 160, 179 },
  { 102, 118, 161, 180 },
  { 102, 117, 162, 181 },
  { 102, 117, 163, 182 },
  { 102, 117, 164, 182 },
  { 101, 116, 165, 183 },
  { 101, 116, 166, 184 },
  { 101, 116, 167, 185 },
  { 101, 116, 168, 186 },
  { 100, 115, 169, 187 },
  { 100, 115, 170, 188 },
  { 100, 115, 171, 189 },
  { 99, 114, 172, 189 },
  { 99, 114, 173, 190 },
  { 99, 114, 174, 190 },
  { 99, 114, 175, 191 },
  { 98, 113, 176, 191 },
  { 98, 113, 177, 192 },
  { 98, 113, 178, 192 },
  { 98, 113, 178, 193 },
  { 98, 113, 179, 193 },
  { 97, 112, 179, 194 },
  { 97, 112, 180, 194 },
  { 97, 111, 180, 194 },
  { 97, 111, 181, 195 },
  { 96, 111, 182, 195 },
  { 96, 111, 182, 195 },
  { 96, 110, 183, 196 },
  { 96, 110, 183, 196 },
  { 96, 110, 183, 196 },
  { 95, 110, 183, 197 },
  { 95, 110, 184, 197 },
  { 95, 109, 184, 197 },
  { 94, 109, 185, 197 },
  { 94, 109, 185, 198 },
  { 94, 109, 185, 198 },
  { 94, 109, 185, 198 },
  { 94, 108, 186, 198 },
  { 93, 108, 186, 198 },
  { 93, 108, 186, 198 },
  { 93, 108, 186, 199 },
  { 93, 108, 186, 199 },
  { 93, 107, 187, 199 },
  { 93, 107, 187, 199 },
  { 92, 107, 187, 200 },
  { 92, 107, 187, 200 },
  { 92, 107, 187, 200 },
  { 92, 107, 187, 200 },
  { 92, 106, 187, 200 },
  { 91, 106, 187, 200 },
  { 91, 106, 187, 200 },
  { 91, 106, 187, 200 },
  { 91, 106, 187, 200 },
  { 91, 105, 187, 200 },
  { 91, 105, 187, 200 },
  { 91, 105, 186, 200 },
  { 90, 105, 186, 199 },
  { 90, 105, 186, 199 },
  { 90, 105, 186, 199 },
  { 90, 105, 186, 199 },
  { 90, 105, 185, 199 },
  { 90, 104, 185, 199 },
  { 89, 104, 185, 199 },
  { 89, 104, 185, 199 },
  { 89, 104, 184, 198 },
  { 89, 104, 184, 198 },
  { 89, 104, 184, 198 },
  { 89, 103, 184, 198 },
  { 88, 103, 183, 198 },
  { 88, 103, 183, 198 },
  { 88, 103, 183, 198 },
  { 88, 103, 183, 197 },
  { 88, 103, 183, 197 },
  { 88, 102, 182, 196 },
  { 88, 102, 182, 196 },
  { 87, 102, 181, 196 },
  { 87, 102, 181, 195 },
  { 87, 102, 180, 195 },
  { 87, 101, 180, 195 },
  { 87, 101, 180, 195 },
  { 87, 101, 180, 194 },
  { 87, 101, 179, 194 },
  { 87, 101, 179, 193 },
  { 86, 101, 178, 193 },
  { 86, 101, 178, 193 },
  { 86, 101, 177, 192 },
  { 86, 101, 177, 191 },
  { 86, 100, 176, 191 },
  { 85, 100, 175, 190 },
  { 85, 100, 175, 190 },
  { 85, 100, 174, 189 },
  { 85, 100, 174, 189 },
  { 85, 100, 173, 188 },
  { 85, 99, 173, 188 },
  { 85, 99, 172, 187 },
  { 85, 99, 171, 186 },
  { 85, 99, 171, 185 },
  { 85, 99, 170, 185 },
  { 85, 99, 169, 184 },
  { 85, 99, 168, 184 },
  { 85, 99, 167, 183 },
  { 85, 99, 166, 183 },
  { 85, 99, 165, 182 },
  { 85, 99, 164, 181 },
  { 85, 99, 163, 181 },
  { 85, 99, 161, 180 },
  { 85, 100, 160, 179 },
  { 85, 100, 158, 178 },
  { 85, 100, 157, 177 },
  { 85, 100, 155, 176 },
  { 86, 100, 154, 175 },
  { 86, 100, 153, 174 },
  { 86, 100, 151, 173 },
  { 86, 100, 149, 172 },
  { 86, 101, 147, 170 },
  { 87, 101, 146, 169 },
  { 87, 101, 143, 168 },
  { 87, 101, 142, 167 },
  { 87, 102, 139, 166 },
  { 87, 102, 136, 165 },
  { 88, 102, 133, 163 },
  { 88, 102, 125, 161 },
  { 88, 103, 117, 160 },
  { 88, 103, 111, 159 },
  { 88, 103, 108, 157 },
  { 88, 103, 102, 155 },
  { 88, 104, 99, 153 },
  { 88, 104, 97, 150 },
  { 89, 104, 96, 149 },
  { 89, 104, 96, 145 },
  { 89, 104, 95, 141 },
  { 89, 104, 95, 135 },
  { 89, 104, 95, 129 },
  { 89, 104, 95, 122 },
  { 89, 103, 95, 120 },
  { 89, 103, 95, 120 },
  { 88, 103, 95, 119 },
  { 88, 103, 95, 119 },
  { 88, 103, 95, 119 },
  { 87, 102, 96, 120 },
  { 87, 102, 96, 123 },
  { 87, 102, 97, 125 },
  { 87, 102, 99, 129 },
  { 86, 102, 100, 133 },
  { 86, 101, 101, 136 },
  { 86, 101, 103, 138 },
  { 86, 101, 104, 140 },
  { 85, 101, 106, 143 },
  { 85, 100, 108, 146 },
  { 85, 100, 110, 148 },
  { 84, 100, 112, 151 },
  { 84, 99, 116, 153 },
  { 84, 99, 118, 155 },
  { 84, 99, 121, 156 },
  { 83, 99, 124, 158 },
  { 83, 98, 126, 159 },
  { 83, 98, 129, 161 },
  { 83, 98, 132, 163 },
  { 82, 98, 134, 164 },
  { 82, 97, 136, 165 },
  { 82, 97, 139, 166 },
  { 82, 97, 142, 168 },
  { 82, 97, 144, 170 },
  { 81, 96, 146, 171 },
  { 81, 96, 148, 172 },
  { 81, 96, 150, 173 },
  { 81, 96, 152, 174 },
  { 81, 96, 153, 174 },
  { 80, 95, 155, 175 },
  { 80, 95, 156, 176 },
  { 80, 95, 158, 177 },
  { 80, 94, 159, 177 },
  { 80, 94, 160, 178 },
  { 80, 94, 162, 179 },
  { 79, 94, 163, 179 },
  { 79, 94, 164, 180 },
  { 79, 94, 165, 181 },
  { 79, 93, 166, 182 },
  { 79, 93, 166, 183 },
  { 79, 93, 167, 183 },
  { 78, 93, 168, 184 },
  { 78, 93, 169, 184 },
  { 78, 93, 169, 185 },
  { 78, 93, 170, 186 },
  { 78, 93, 170, 186 },
  { 78, 92, 171, 186 },
  { 78, 92, 171, 187 },
  { 78, 92, 172, 188 },
  { 78, 92, 173, 188 },
  { 77, 92, 173, 189 },
  { 77, 92, 173, 189 },
  { 77, 92, 174, 189 },
  { 77, 92, 175, 190 },
  { 77, 91, 175, 190 },
  { 77, 91, 176, 191 },
  { 76, 91, 177, 192 },
  { 76, 91, 177, 192 },
  { 76, 91, 177, 192 },
  { 76, 91, 178, 192 },
  { 76, 91, 178, 193 },
  { 76, 91, 179, 194 },
  { 76, 90, 179, 194 },
  { 76, 90, 180, 194 },
  { 76, 90, 180, 194 },
  { 76, 90, 180, 194 },
  { 76, 90, 180, 195 },
  { 76, 90, 181, 195 },
  { 76, 90, 181, 195 },
  { 76, 90, 181, 195 },
  { 76, 90, 182, 195 },
  { 76, 90, 182, 195 },
  { 76, 90, 182, 195 },
  { 76, 90, 182, 195 },
  { 76, 90, 182, 196 },
  { 76, 90, 182, 196 },
  { 76, 90, 182, 196 },
  { 76, 90, 182, 196 },
  { 76, 90, 182, 196 },
  { 76, 90, 182, 196 },
  { 76, 90, 182, 196 },
  { 76, 90, 182, 196 },
  { 76, 91, 182, 196 },
  { 76, 91, 182, 195 },
  { 76, 91, 182, 195 },
  { 77, 91, 181, 195 },
  { 77, 91, 181, 195 },
  { 77, 91, 181, 195 },
  { 77, 91, 181, 195 },
  { 77, 92, 181, 195 },
  { 78, 92, 180, 195 },
  { 78, 92, 180, 195 },
  { 78, 92, 180, 195 },
  { 78, 92, 180, 195 },
  { 78, 92, 180, 194 },
  { 78, 92, 179, 194 },
  { 78, 92, 179, 194 },
  { 78, 93, 179, 193 },
  { 79, 93, 178, 193 },
  { 79, 93, 178, 192 },
  { 79, 93, 177, 192 },
  { 79, 93, 177, 191 },
  { 79, 93, 176, 191 },
  { 79, 94, 176, 190 },
  { 80, 94, 176, 190 },
  { 80, 94, 175, 190 },
  { 80, 94, 175, 189 },
  { 80, 94, 174, 188 },
  { 80, 95, 173, 188 },
  { 81, 95, 173, 187 },
  { 81, 96, 172, 186 },
  { 81, 96, 171, 186 },
  { 81, 96, 170, 185 },
  { 82, 96, 170, 185 },
  { 82, 97, 169, 184 },
  { 82, 97, 168, 183 },
  { 82, 97, 168, 183 },
  { 83, 98, 167, 182 },
  { 83, 98, 166, 181 },
  { 83, 98, 165, 181 },
  { 83, 99, 164, 180 },
  { 84, 99, 163, 179 },
  { 84, 99, 162, 178 },
  { 84, 100, 161, 177 },
  { 85, 100, 160, 177 },
  { 85, 100, 159, 176 },
  { 85, 101, 158, 175 },
  { 86, 101, 157, 174 },
  { 86, 102, 156, 173 },
  { 87, 102, 155, 173 },
  { 87, 102, 154, 172 },
  { 88, 103, 153, 171 },
  { 88, 104, 152, 170 },
  { 89, 104, 151, 169 },
  { 89, 105, 149, 168 },
  { 89, 105, 148, 167 },
  { 90, 106, 147, 167 },
  { 90, 106, 145, 166 },
  { 90, 107, 144, 164 },
  { 91, 107, 143, 163 },
  { 91, 108, 142, 162 },
  { 92, 108, 141, 161 },
  { 92, 109, 140, 160 },
  { 93, 109, 139, 158 },
  { 93, 110, 137, 157 },
  { 94, 110, 136, 156 },
  { 94, 111, 135, 155 },
  { 95, 111, 134, 154 },
  { 96, 112, 133, 152 },
  { 96, 112, 132, 151 },
  { 97, 113, 131, 150 },
  { 98, 114, 129, 148 },
  { 98, 114, 128, 147 },
  { 99, 115, 126, 146 },
  { 99, 116, 125, 145 },
  { 100, 116, 123, 144 },
  { 101, 117, 122, 143 },
  { 101, 118, 120, 142 },
  { 102, 118, 118, 141 },
  { 102, 119, 117, 140 },
  { 103, 119, 115, 138 },
  { 103, 120, 114, 137 },
  { 104, 120, 113, 135 },
  { 104, 121, 112, 133 },
  { 105, 121, 111, 131 },
  { 105, 122, 110, 130 },
  { 106, 122, 110, 129 },
  { 106, 122, 109, 128 },
  { 107, 122, 109, 126 },
  { 107, 122, 109, 125 },
  { 108, 122, 109, 124 },
  { 109, 122, 109, 123 },
  { 109, 122, 110, 122 },
  { 110, 122, 110, 122 },
  { 111, 121, 111, 120 },
  { 114, 119, 113, 117 },
};

#define LIMIT_OFFSET LIDS_OFFSET

static int limit[LIDS_WIDTH];

static void lids(int close)
{
  if (close == 0)
    for (int x = 0; x < LIDS_WIDTH; x++)
    {
      for (int y = lids_ranges[x][0]; y < lids_ranges[x][1]; y++)
	display_set_virt(x + LIDS_OFFSET, y, true);
      limit[x] = lids_ranges[x][1];
    }
  else
  {
    int open = 100 - close;
    for (int x = 0; x < LIDS_WIDTH; x++)
    {
      int y = (open * lids_ranges[x][0] + close * lids_ranges[x][2]) / 100;
      int yy = (open * lids_ranges[x][1] + close * lids_ranges[x][3]) / 100;
      for (; y < yy; y++)
	display_set_virt(x + LIDS_OFFSET, y, true);
      limit[x] = yy;
    }
  }
}

// <<<
//******************************************************************************
// >>> left

#define LEFT_OFFSET 135
#define LEFT_WIDTH 66

static int left_range[LEFT_WIDTH][2] =
{
  { 120, 136 },
  { 116, 140 },
  { 114, 143 },
  { 111, 146 },
  { 109, 148 },
  { 107, 150 },
  { 105, 151 },
  { 104, 152 },
  { 103, 153 },
  { 102, 155 },
  { 101, 156 },
  { 101, 157 },
  { 100, 158 },
  { 100, 159 },
  { 99, 160 },
  { 99, 160 },
  { 98, 161 },
  { 98, 161 },
  { 97, 162 },
  { 97, 162 },
  { 96, 163 },
  { 96, 163 },
  { 96, 163 },
  { 95, 164 },
  { 95, 164 },
  { 95, 164 },
  { 94, 165 },
  { 94, 165 },
  { 94, 166 },
  { 94, 166 },
  { 94, 166 },
  { 94, 166 },
  { 94, 166 },
  { 94, 166 },
  { 94, 166 },
  { 94, 166 },
  { 94, 166 },
  { 94, 166 },
  { 94, 166 },
  { 94, 166 },
  { 94, 166 },
  { 94, 165 },
  { 95, 165 },
  { 95, 164 },
  { 95, 164 },
  { 95, 164 },
  { 95, 163 },
  { 96, 163 },
  { 96, 162 },
  { 96, 161 },
  { 97, 161 },
  { 97, 160 },
  { 98, 160 },
  { 98, 159 },
  { 99, 158 },
  { 99, 157 },
  { 100, 155 },
  { 101, 154 },
  { 102, 152 },
  { 104, 151 },
  { 105, 150 },
  { 107, 148 },
  { 110, 145 },
  { 113, 142 },
  { 117, 138 },
  { 124, 131 },
};

static void left(int x_off, int y_off)
{
  for (int x = 0; x < LEFT_WIDTH; x++)
  {
    int y = left_range[x][0];
    int yy = limit[x + LEFT_OFFSET + x_off - LIMIT_OFFSET] + y_off + 1;
    if (y < yy)
      y = yy;
    for (; y < left_range[x][1]; y++)
      display_set_virt(x + LEFT_OFFSET + x_off, y - y_off, true);
  }
}

// <<<
//******************************************************************************
// >>> right

#define RIGHT_OFFSET 255
#define RIGHT_WIDTH 67

static int right_range[RIGHT_WIDTH][2] =
{
  { 113, 123 },
  { 107, 129 },
  { 104, 133 },
  { 101, 136 },
  { 99, 139 },
  { 97, 141 },
  { 96, 143 },
  { 95, 144 },
  { 93, 145 },
  { 92, 147 },
  { 91, 148 },
  { 90, 150 },
  { 90, 151 },
  { 89, 152 },
  { 89, 153 },
  { 89, 153 },
  { 88, 154 },
  { 88, 155 },
  { 88, 155 },
  { 87, 156 },
  { 87, 157 },
  { 87, 158 },
  { 87, 158 },
  { 86, 159 },
  { 86, 159 },
  { 86, 159 },
  { 86, 159 },
  { 85, 160 },
  { 85, 160 },
  { 85, 160 },
  { 85, 160 },
  { 85, 160 },
  { 85, 160 },
  { 85, 161 },
  { 85, 161 },
  { 85, 160 },
  { 86, 160 },
  { 86, 160 },
  { 86, 160 },
  { 86, 160 },
  { 86, 160 },
  { 87, 160 },
  { 87, 159 },
  { 87, 159 },
  { 88, 159 },
  { 88, 158 },
  { 89, 158 },
  { 89, 157 },
  { 90, 157 },
  { 91, 156 },
  { 91, 155 },
  { 92, 155 },
  { 93, 154 },
  { 94, 153 },
  { 95, 153 },
  { 96, 152 },
  { 97, 151 },
  { 98, 150 },
  { 99, 149 },
  { 100, 148 },
  { 102, 146 },
  { 104, 145 },
  { 106, 143 },
  { 108, 141 },
  { 110, 139 },
  { 114, 135 },
  { 119, 130 },
};

static void right(int x_off, int y_off)
{
  for (int x = 0; x < RIGHT_WIDTH; x++)
  {
    int y = right_range[x][0];
    int yy = limit[x + RIGHT_OFFSET + x_off - LIMIT_OFFSET] + y_off + 1;
    if (y < yy)
      y = yy;
    for (; y < right_range[x][1]; y++)
      display_set_virt(x + RIGHT_OFFSET + x_off, y - y_off, true);
  }
}

// <<<
//******************************************************************************

// TODO
// blink
// eye positions
//   dizzy
//   straight
//   dream left up
//   left down
//   right down
// sleep

int main(int ac, const char *av[])
{
  int display_select = 0;
  for (int ai = 1; ai < ac; ai++)
  {
    assert(av[ai][0] == '-');
    switch (av[ai][1])
    {
    case 'x':
      display_select |= DISPLAY_SELECT_GX;
      break;
    case 's':
      display_select |= DISPLAY_SELECT_SP;
      break;
    default:
      assert(0);
    }
  }
  display_create(display_select);

  int mode = 0;
  int axis = 0;
  int left_x = 0;
  int left_y = 0;
  int right_x = 0;
  int right_y = 0;
  int close = 0;
  for (;;)
  {
    display_clear();
    border();
    lids(close);
    left(left_x, left_y);
    right(right_x, right_y);
    
    int button = display_button();
    switch (button)
    {
    case 9:
      goto END;

    case 1:
      mode = 1;
      break;
    case 2:
      mode = 0;
      break;
    case 3:
      mode = 2;
      break;
    case 8:
      axis = !axis;
      break;

    case 4: // up
      if (mode == 0)
      {
	if (close > -20)
	  close--;
      }
      else if (mode == 1)
      {
	if (axis)
	  left_x++;
	else
	  left_y++;
      }
      else if (mode == 2)
      {
	if (axis)
	  right_x--;
	else
	  right_y--;
      }
      break;
    case 5: // down
      if (mode == 0)
      {
	if (close < 100)
	  close++;
      }
      else if (mode == 1)
      {
	if (axis)
	  left_x--;
	else
	  left_y--;
      }
      else if (mode == 2)
      {
	if (axis)
	  right_x++;
	else
	  right_y++;
      }
      break;
    }

    if (button)
      printf("close=%d left=%d/%d right=%d/%d\n", close, left_x, left_y, right_x, right_y);

    display_flush();
    usleep(DELAY * 1000);
  }
END:

  display_free();
  return EXIT_SUCCESS;
}

//******************************************************************************
