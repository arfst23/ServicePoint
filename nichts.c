//******************************************************************************

#include "display.h"

#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <time.h>
#include <assert.h>

#define DELAY 35

#define delay(ms) usleep(ms * 1000)

//******************************************************************************

uint16_t chars[10][20] =
{
  { // 0 N
    0b11100000000011,
    0b11110000000011,
    0b11110000000011,
    0b11011000000011,
    0b11011000000011,
    0b11001100000011,
    0b11001100000011,
    0b11000110000011,
    0b11000110000011,
    0b11000011000011,
    0b11000011000011,
    0b11000001100011,
    0b11000001100011,
    0b11000000110011,
    0b11000000110011,
    0b11000000011011,
    0b11000000011011,
    0b11000000001111,
    0b11000000001111,
    0b11000000000111,
  },
  { // 1 I
    0b00111111111100,
    0b00111111111100,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00111111111100,
    0b00111111111100,
  },
  { // 2 C
    0b00011111111000,
    0b00111111111100,
    0b01100000000110,
    0b11000000000011,
    0b11000000000011,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000011,
    0b11000000000011,
    0b01100000000110,
    0b00111111111100,
    0b00011111111000,
  },
  { // 3 H
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11111111111111,
    0b11111111111111,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
  },
  { // 4 T
    0b11111111111111,
    0b11111111111111,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
    0b00000011000000,
  },
  { // 5 S
    0b00011111111000,
    0b00111111111100,
    0b01100000000110,
    0b11000000000011,
    0b11000000000000,
    0b01100000000000,
    0b00111111111000,
    0b00011111111100,
    0b00000000000110,
    0b00000000000011,
    0b00000000000011,
    0b00000000000011,
    0b00000000000011,
    0b00000000000011,
    0b00000000000011,
    0b11000000000011,
    0b11000000000011,
    0b01100000000110,
    0b00111111111100,
    0b00011111111000,
  },
  { // 6 O
    0b00011111111000,
    0b00111111111100,
    0b01100000000110,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b01100000000110,
    0b00111111111100,
    0b00011111111000,
  },
  { // 7 W
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000000000011,
    0b11000011000011,
    0b11000111100011,
    0b11000111100011,
    0b01101100110110,
    0b01101100110110,
    0b00111000011100,
    0b00111000011100,
    0b00111000011100,
  },
  { // 8 E
    0b11111111111111,
    0b11111111111111,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11111111110000,
    0b11111111110000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11000000000000,
    0b11111111111111,
    0b11111111111111,
  },

  { // 9 ,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00000000000000,
    0b00111000000000,
    0b00111000000000,
    0b00110000000000,
    0b01100000000000,
  },
};

//******************************************************************************

void print_word(int x, int y,uint16_t word)
{
  for (int xx = 0; xx < 14; xx++)
    display_set_virt(x + xx, y, (word << xx) & 0b10000000000000);
}

void print_char(int x, int y, int r, int c)
{
  int rot[12] = { 20, 20, 19, 18, 17, 15, 13, 11, 8, 6, 3, 0 };  
  if (r == 0)
    for (int yy = 0; yy < 20; yy++)
      print_word(x, y + yy, chars[c][yy]);
  else if (r > 0)
  {
    int rr = rot[r];
    int yyy = 20 - rr;
    for (int yy = 0; yy < rr; yy++)
      print_word(x, y + yy + yyy, chars[c][20 *yy / rr]);
  }
  else // r < 0
  {
    int rr = rot[-r];
    for (int yy = 0; yy < rr; yy++)
      print_word(x, y + yy, chars[c][(20 * yy + rr - 1) / rr]);
  }
}

void print_str(int x, int y, int r, const int *str, int l)
{
  for (int i = 0; i < l; i++)
    if (str[i] >= 0)
      print_char(x + i * 16, y, r, str[i]);
}

void print(int s, int r)
{
  static const int strs[2][14] =
  {
  //  N  I  C  H  T  S      I  S  T      S  O  ,
    { 0, 1, 2, 3, 4, 5, -1, 1, 5, 4, -1, 5, 6, 9 },
  //  W  I  E      E  S      S  C  H  E  I  N  T
    { 7, 1, 8, -1, 8, 5, -1, 5, 2, 3, 8, 1, 0, 4 }
  };

  print_str(8 * 14 - s, 12 * 8,      r, &strs[0][0], 14);
  print_str(8 * 14 + s, 12 * 8 + 24, -r, &strs[1][0], 14);
}

//******************************************************************************

void swap()
{
  int s[] = { 1, 2, 4, 7, 11, 16, 22, 29, 36, 44, 52, 60, 68, 75, 83, 90, 96,
    101, 105, 108, 110, 111, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112  };
  int r[] = { 0, 0, 0, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
      0,   0,   0,   0,   1,   2,   3,   4,   5,   6,   7,   8,   9,  10,  11  };

  if (rand() & 1)
  {
    for (int t = 0; t < 32; t++)
    {
      display_clear();
      print(s[t], r[t]);
      display_flush();
      delay(DELAY);
    }
    for (int t = 31; t >= 0; t--)
    {
      display_clear();
      print(-s[t], r[t]);
      display_flush();
      delay(DELAY);
    }
  }
  else
  {
    for (int t = 0; t < 32; t++)
    {
      display_clear();
      print(-s[t], r[t]);
      display_flush();
      delay(DELAY);
    }
    for (int t = 31; t >= 0; t--)
    {
      display_clear();
      print(s[t], r[t]);
      display_flush();
      delay(DELAY);
    }
  }

}

int main(int ac, char *av[])
{
  int display_select = 0;
  int rounds = 0;
  for (int ai = 1; ai < ac; ai++)
  {
    assert(av[ai][0] == '-');
    if (av[ai][1] == 's')
      display_select |= DISPLAY_SELECT_SP;
    else if (av[ai][1] == 'x')
      display_select |= DISPLAY_SELECT_GX;
    else if (isdigit(av[ai][1]))
      rounds = atoi(&av[ai][1]);
    else
      assert(0);
  }

  srand(time(NULL));
  display_create(display_select);

  while (!display_button())
  {
    display_clear();
    print(0, 0);
    display_flush();
    int dur = 7000 + rand() % 7000;
    delay(dur);
    
    swap();

    if (rounds && !--rounds)
      break;
  }

  display_free();

  return EXIT_SUCCESS;
}

//******************************************************************************
